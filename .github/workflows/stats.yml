name: Generate GitHub Stats

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Generate stats
        shell: bash
        run: |
          set -e

          USER="PriyanshuSingh44"
          TOKEN="${{ secrets.GITHUB_TOKEN }}"
          ACCEPT="application/vnd.github.cloak-preview+json"

          curl -s -H "Authorization: token $TOKEN" "https://api.github.com/users/$USER/repos?per_page=100" > repos.json
          curl -s -H "Authorization: token $TOKEN" "https://api.github.com/search/issues?q=author:$USER+type:pr" > prs.json
          curl -s -H "Authorization: token $TOKEN" "https://api.github.com/search/issues?q=author:$USER+type:issue" > issues.json
          curl -s -H "Authorization: token $TOKEN" -H "Accept: $ACCEPT" "https://api.github.com/search/commits?q=author:$USER" > commits.json

          STARS=$(jq '[.[].stargazers_count] | add // 0' repos.json)
          PRS=$(jq '.total_count // 0' prs.json)
          ISSUES=$(jq '.total_count // 0' issues.json)
          COMMITS=$(jq '.total_count // 0' commits.json)
          CONTRIBUTED=$(jq '[.[] | select(.fork == false)] | length' repos.json)

          jq -r '.[].languages_url' repos.json | while read -r url; do
            curl -s -H "Authorization: token $TOKEN" "$url"
          done | jq -s 'reduce .[] as $i ({}; reduce ($i | keys[]) as $k (. ; .[$k] += $i[$k]))' > langs.json || echo "{}" > langs.json

          TOTAL=$(jq '[.[]] | add // 1' langs.json)

          jq -r --arg total "$TOTAL" '
            to_entries | sort_by(-.value) | .[0:5] |
            .[] | "\(.key) \(.value*100/$total)"
          ' langs.json > langs.txt || true

          echo "<svg xmlns='http://www.w3.org/2000/svg' width='520' height='210'>
          <rect width='100%' height='100%' rx='14' ry='14' fill='#141321'/>
          <text x='20' y='35' fill='#c792ea' font-size='18'>$USER GitHub Stats</text>
          <text x='20' y='70' fill='#89ddff'>Stars: $STARS</text>
          <text x='20' y='95' fill='#82aaff'>Commits: $COMMITS</text>
          <text x='20' y='120' fill='#c3e88d'>PRs: $PRS</text>
          <text x='20' y='145' fill='#f78c6c'>Issues: $ISSUES</text>
          <text x='20' y='170' fill='#ffcb6b'>Contributed: $CONTRIBUTED</text>
          </svg>" > stats.svg

          y=50
          BARS=""
          while read -r name val; do
            width=$(printf "%.0f" "$(echo "$val*2.5" | bc)")
            BARS="$BARS
          <text x='20' y='$y' fill='#82aaff'>$name</text>
          <rect x='140' y='$((y-12))' rx='6' ry='6' width='250' height='10' fill='#2d2b55'/>
          <rect x='140' y='$((y-12))' rx='6' ry='6' width='$width' height='10' fill='#c792ea'/>
          <text x='410' y='$y' fill='#c3e88d'>$(printf "%.1f" "$val")%</text>"
            y=$((y+28))
          done < langs.txt

          echo "<svg xmlns='http://www.w3.org/2000/svg' width='460' height='220'>
          <rect width='100%' height='100%' rx='14' ry='14' fill='#141321'/>
          <text x='20' y='30' fill='#c792ea' font-size='18'>Most Used Languages</text>
          $BARS
          </svg>" > langs.svg

      - name: Commit results
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add stats.svg langs.svg
          git commit -m "Update GitHub stats" || echo "No changes"
          git push
