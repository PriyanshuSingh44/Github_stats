name: Generate GitHub Stats

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Generate stats
        shell: bash
        run: |
          set -e

          USER="PriyanshuSingh44"
          TOKEN="${{ secrets.GITHUB_TOKEN }}"
          ACCEPT="application/vnd.github.cloak-preview+json"

          curl -s -H "Authorization: token $TOKEN" "https://api.github.com/users/$USER/repos?per_page=100" > repos.json
          curl -s -H "Authorization: token $TOKEN" "https://api.github.com/search/issues?q=author:$USER+type:pr" > prs.json
          curl -s -H "Authorization: token $TOKEN" "https://api.github.com/search/issues?q=author:$USER+type:issue" > issues.json
          curl -s -H "Authorization: token $TOKEN" -H "Accept: $ACCEPT" "https://api.github.com/search/commits?q=author:$USER" > commits.json

          STARS=$(jq '[.[].stargazers_count] | add // 0' repos.json)
          PRS=$(jq '.total_count // 0' prs.json)
          ISSUES=$(jq '.total_count // 0' issues.json)
          COMMITS=$(jq '.total_count // 0' commits.json)
          CONTRIBUTED=$(jq '[.[] | select(.fork == false)] | length' repos.json)

          jq -r '.[].languages_url' repos.json | while read -r url; do
            curl -s -H "Authorization: token $TOKEN" "$url"
          done | jq -s 'reduce .[] as $i ({}; reduce ($i | keys[]) as $k (. ; .[$k] += $i[$k]))' > langs.json || echo "{}" > langs.json

          TOTAL=$(jq '[.[]] | add // 1' langs.json)

          jq -r --arg total "$TOTAL" '
            to_entries | sort_by(-.value) | .[0:5] |
            .[] | "\(.key) \(.value*100/$total)"
          ' langs.json > langs.txt || true

          cat > stats.svg <<EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="640" height="200">
            <defs>
              <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="#0f2027"/>
                <stop offset="50%" stop-color="#203a43"/>
                <stop offset="100%" stop-color="#2c5364"/>
              </linearGradient>
            </defs>
          
            <rect width="100%" height="100%" rx="16" ry="16" fill="url(#bg)"/>
          
            <text x="30" y="35" fill="#9cdcfe" font-size="20" font-weight="bold">$USER GitHub Stats</text>
          
            <text x="30" y="70" fill="#c586c0" font-size="14">‚≠ê Total Stars:</text>
            <text x="200" y="70" fill="#ffffff" font-size="14">$STARS</text>
          
            <text x="30" y="95" fill="#4ec9b0" font-size="14">üßæ Total Commits:</text>
            <text x="200" y="95" fill="#ffffff" font-size="14">$COMMITS</text>
          
            <text x="30" y="120" fill="#dcdcaa" font-size="14">üîÄ Total PRs:</text>
            <text x="200" y="120" fill="#ffffff" font-size="14">$PRS</text>
          
            <text x="30" y="145" fill="#ce9178" font-size="14">üêû Total Issues:</text>
            <text x="200" y="145" fill="#ffffff" font-size="14">$ISSUES</text>
          
            <text x="30" y="170" fill="#569cd6" font-size="14">üåç Contributed To:</text>
            <text x="200" y="170" fill="#ffffff" font-size="14">$CONTRIBUTED</text>
          
            <!-- Score Circle -->
            <circle cx="520" cy="105" r="45" fill="none" stroke="#3fa9f5" stroke-width="6"/>
            <text x="495" y="115" fill="#3fa9f5" font-size="24" font-weight="bold">A+</text>
          
          </svg>
          EOF


          y=50
          BARS=""
          while read -r name val; do
            width=$(printf "%.0f" "$(echo "$val*2.5" | bc)")
            BARS="$BARS
          <text x='20' y='$y' fill='#82aaff'>$name</text>
          <rect x='140' y='$((y-12))' rx='6' ry='6' width='250' height='10' fill='#2d2b55'/>
          <rect x='140' y='$((y-12))' rx='6' ry='6' width='$width' height='10' fill='#c792ea'/>
          <text x='410' y='$y' fill='#c3e88d'>$(printf "%.1f" "$val")%</text>"
            y=$((y+28))
          done < langs.txt

          echo "<svg xmlns='http://www.w3.org/2000/svg' width='460' height='220'>
          <rect width='100%' height='100%' rx='14' ry='14' fill='#141321'/>
          <text x='20' y='30' fill='#c792ea' font-size='18'>Most Used Languages</text>
          $BARS
          </svg>" > langs.svg

      - name: Commit results
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add stats.svg langs.svg
          git commit -m "Update GitHub stats" || echo "No changes"
          git push
